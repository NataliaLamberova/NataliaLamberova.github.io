---
title: "R Review"
author: "Anton Sobolev"
date: "5/15/2018"
# output: ioslides_presentation
  # output:
  # html_document: default
  # pdf_document: default
---
# We start with some hints on working with R
## Loading packages
Loading packages is boring and time-consuming.
```{r}
install.packages("pacman")
library("pacman")
library("dplyr")
```
Easy way: `pacman`.
This package check if the package has been installed already and load it. No need to use quotes.
```{r, include=FALSE}
if (!require("pacman")) install.packages("pacman")
p_load(data.table, dplyr, plyr, ggplot2, rlang, estimatr, texreg, dotwhisker, multiwayvcov, lmtest, stargazer)
```
## R can do a lot for you
Work with and organize your file system.
```{r}

setwd("..")
setwd("data")
unzip("hotel_reviews_data.zip")
```
Note: after each chunk your default `working directory` is a folder with your .Rmd file. Is it good or bad?
```{r}
getwd()
setwd("archives")
archive.files <- list.files()
archive.files
lapply(archive.files, unzip)
```
## Loading data
Useful packages: `data.table`, `haven`
```{r}
system.time.1 <- system.time(d <- read.csv("data/hotel_reviews_data.csv", stringsAsFactors = F))
system.time.2 <- system.time(d <- fread("data/hotel_reviews_data.csv", stringsAsFactors = F))
# Let's compare the waiting time
system.time.1; system.time.2
```
# Working example from Card and Krueger (1994) "Minimum Wages and Employment: A Case Study of the Fast Food Industry in New Jersey and Pennsylvania"
## Formatting data
```{r}
load("data/Card-and-Krueger.Rdata")
# Print out the first 10 rows
d[1:10,]
```
Can we use it for $D-i-D$ estimation?

What columns do we need to run D-i-D regression?

```{r}
d.1 <- cbind(state = d$state, chain = d$chain, wage = d$wage_pre, emp = d$emp_pre, t = 0) %>% data.table()

d.2 <- cbind(state = d$state, chain = d$chain, wage = d$wage_post, emp = d$emp_post, t = 1) %>% data.table()

d.list <- list(d.1, d.2)

d <- rbindlist(d.list) # extremely useful for compiling large datasets

fwrite(d, "data/normal-data.csv", row.names = F, quote = F) # extremely useful for writing large datasets
rm(list=ls())
```

```{r}
d <- fread("data/normal-data.csv", stringsAsFactors = F)
```

```{r}
glimpse(d)
```
Let's recode the `chain` variable
```{r}
# 1=bk; 2=kfc; 3=roys; 4=wendys - from the codebook of the study
bad.names <- c(1:4)
good.names <- c("bk", "kfc", "roys", "wendys")
d$chain <- mapvalues(d$chain, from = bad.names, to = good.names)
```

```{r}
# Stata's legacy
model.wrong <- lm(data= d, emp ~ state + t + state*t)
# Correct version of interacting covariates
model.1 <- lm(data= d, emp ~ factor(state) + factor(t) + state:t)
summary(model.1)
```
What can be wrong about this model?
Allow for correlation in error term at the level of... ?
Option 1: `lm_robust` from `estimatR` package
```{r}
model.2 <- lm_robust(data = d, emp ~ factor(state) + factor(t) + state:t, clusters = chain, se_type = "stata")
```
Option 2 (better): calculate Variance-Covarience matrix and feed it `coeftest`
```{r}
vcov_firm <- cluster.vcov(model.1, cluster = d$chain)
model.with.robust.se <- coeftest(model.1, vcov_firm)
```
# Compare models with `screenreg` from `texreg` package
```{r}
screenreg(list(model.1, model.with.robust.se, model.2),
       caption="Model Comparison",
       dcolumn=FALSE,
       model.names=c("M1", "M2")
       )
```

```{r}
model.3 <- lm_robust(data = d, emp ~ factor(state) + factor(t) + state:t + factor(chain), clusters = chain , se_type = "stata")

model.4 <- lm_robust(data = d, emp ~ factor(state) + factor(t) + state:t + factor(chain), clusters = chain)
# Let's redefine model 1
model.1 <- lm_robust(data= d, emp ~ factor(state) + factor(t) + state:t)
```

# Compare the models
```{r}
screenreg(list(model.1, model.2, model.3, model.4),
       caption="Model Comparison",
       dcolumn=FALSE
       )
```
How to drop fixed effects from the report?
```{r}
vars.of.interest.list <- list("state:t" = "interaction",
                     "factor(t)1" = "period",
                     "factor(state)2" = "treatment",
                     "(Intercept)" = "Constant")

screenreg(list(model.1, model.2, model.3, model.4),
       caption="Compare Models",
       dcolumn=FALSE,
       custom.coef.map =  vars.of.interest.list
       )
```

# Plots are often more useful
```{r}
# Convert models to data.frames
m1 <- tidy(model.1)[,1:3] %>% mutate(model = "Model 1")
m2 <- tidy(model.2)[,1:3] %>% mutate(model = "Model 2")
m3 <- tidy(model.3)[,1:3] %>% mutate(model = "Model 3")
# Combine them together
m.pooled <- rbind(m1,m2, m3)
# Draw
dwplot(m.pooled) + theme_bw()
# Keep only those of the interest 
terms.of.interest <- c("state:t", "factor(state)2")

m.pooled[m.pooled$term %in% terms.of.interest,] %>% dwplot() + theme_bw()
```

# Separate effect for each chain
```{r}
a <- b <- c <- NA
unique(d$chain)
d.bk <- d[d$chain=="bk",]
d.kfc <- d[d$chain=="kfc",]
d.wendys <- d[d$chain=="wendys",]
d.roys <- d[d$chain=="roys",]
```
# Employemnt segment

```{r}
d.bk$employment_segment <- d.bk[d.bk$emp > mean(d.bk$emp), ]
```


